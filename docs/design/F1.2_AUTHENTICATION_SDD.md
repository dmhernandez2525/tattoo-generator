# Software Design Document - F1.2 Authentication

**Version:** 1.0.0
**Status:** ðŸŸ¨ In Progress
**Last Updated:** 2026-02-03

## 1. Overview

### Purpose
Implement secure user authentication and onboarding with Clerk for the INK SYNTHESIS platform, including social login, email verification, user profiles, and account settings.

### Goals
- Integrate Clerk authentication with Next.js App Router.
- Support email/password and OAuth providers (Google, Apple).
- Enforce email verification.
- Create onboarding flow that persists a user profile in PostgreSQL.
- Provide account settings for profile management.

### Non-Goals
- Billing or subscription management (handled in later phases).
- Marketplace or artist-specific verification (Phase 6+).

## 2. Architecture

### Authentication Stack
- **Clerk** for auth UI, session management, and OAuth providers.
- **Next.js Middleware** for route protection.
- **Prisma** for user profile persistence.

### Key Routes
- `app/sign-in/[[...sign-in]]/page.tsx` (Clerk SignIn)
- `app/sign-up/[[...sign-up]]/page.tsx` (Clerk SignUp)
- `app/onboarding/page.tsx` (profile completion)
- `app/account/page.tsx` (account settings)

### Middleware
- `middleware.ts` uses `@clerk/nextjs/server` to protect routes.
- Public routes include marketing pages and auth pages.

## 3. Data Model

### User Profile
- Stored in `User` model (Prisma) with `clerkId` as unique identifier.
- Fields include name, email, role, avatar URL, and onboarding completion flag.
- During early implementation, profile data is stored in Clerk public metadata via `/api/profile`.

### Role Types
- `user` (default)
- `artist` (future expansion)
- `admin` (internal)

## 4. User Flows

### Sign Up
1. User visits `/sign-up`.
2. Completes Clerk sign-up (email or OAuth).
3. If email verification required, completes verification.
4. Redirect to `/onboarding`.
5. Onboarding form writes profile to database and marks `onboardingCompleted`.
6. Redirect to `/dashboard` (future) or `/` for now.

### Sign In
1. User visits `/sign-in`.
2. Completes Clerk sign-in.
3. If profile exists and onboarding complete, redirect to `/`.
4. Otherwise redirect to `/onboarding`.

### Account Settings
- User can update display name and profile image.
- Profile changes persisted in Prisma and synced with Clerk user metadata where needed.

### Demo Mode
- When `NEXT_PUBLIC_DEMO_MODE=true`, auth pages render a demo role selector.
- Middleware bypasses Clerk protection for demo routes.
- Demo routes live under `/demo` and provide a no-auth experience.

## 5. Components

### Auth Pages
- `SignInPage` and `SignUpPage` wrappers that render Clerk components.

### Onboarding
- `OnboardingForm` (client component)
  - Fields: display name, preferred style, role selection (user/artist).
  - Validation via Zod.
  - Writes to `/api/profile`.

### Account Settings
- `AccountSettingsForm` (client component)
  - Editable fields: display name, bio, avatar.
  - Uses server actions or API route with Prisma.

## 6. Error Handling

- All auth-related API calls return typed results (`Result<T, Error>`).
- UI shows inline errors and toasts (via shared notification system).
- Middleware redirects unauthenticated users cleanly.

## 7. Security

- Protect authenticated routes with Clerk middleware.
- Never expose secrets in client bundles.
- Ensure profile APIs validate `auth.userId`.

## 8. Testing & Validation

### Unit Tests
- Validation schemas for onboarding and account settings.
- Helper utilities for auth redirects.

### Integration Tests
- Auth redirects and onboarding persistence.

### E2E Tests (Playwright)
- Sign-up flow with email verification mocked.
- OAuth login flow stubbed.
- Onboarding completion redirects.

## 9. Open Questions

- Final destination after onboarding (dashboard vs. home) depends on upcoming Phase 2 features.
- OAuth provider requirements for production keys (Apple requires service ID and domain verification).
